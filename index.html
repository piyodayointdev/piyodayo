<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Piyo Profile</title>

<script>
// =========================================================
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡è¦–ã™ã‚‹ãŸã‚ã®å…±é€šé–¢æ•°ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
// =========================================================
const TIMESTAMP = new Date().getTime(); 

function getCacheBustedUrl(url) {
    if (url.includes('?')) {
        return `${url}&t=${TIMESTAMP}`;
    }
    return `${url}?t=${TIMESTAMP}`;
}

// æ¯å›é–‹ããŸã³ã«æ–°ã—ã„ãƒ•ã‚©ãƒ³ãƒˆãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å‡¦ç†
(function() {
    // @font-faceãƒ«ãƒ¼ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã®ãŸã‚ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    const fontRules = `
        @font-face {
            font-family: 'Jfont';
            src: url('${getCacheBustedUrl('Jfont.woff')}') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap; 
        }
        @font-face {
            font-family: 'Efont';
            src: url('${getCacheBustedUrl('Efont.woff')}') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
    `;
    
    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚¿ã‚°ã‚’ä½œæˆã—ã€å®šç¾©ã—ãŸãƒ«ãƒ¼ãƒ«ã‚’<head>ã«æŒ¿å…¥
    const style = document.createElement('style');
    style.textContent = fontRules;
    document.head.appendChild(style);
})();
</script>

<style>
/* ---------------- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« ---------------- */
*{margin:0;padding:0;box-sizing:border-box;}
body,html{
  width:100%;height:100%;overflow-x:hidden; 
  font-family:'Jfont','Efont',sans-serif;
  font-size:16px;color:white;background:#000;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ---------------- èƒŒæ™¯å‹•ç”» ---------------- */
#background-video{
  position:fixed; top:50%; left:50%;
  width:110%; height:110%;
  transform:translate3d(-50%,-50%,0) scale(1.1);
  object-fit:cover; z-index:0; will-change: transform;
  filter: blur(5px); 
}

/* ---------------- ä¸»è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ---------------- */
.center-box{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  text-align:center; z-index:2;
  transition: top 0.3s ease, transform 0.3s ease; 
}
.icon{width:150px; height:150px; border-radius:50%; overflow:hidden; box-shadow:0 0 40px rgba(246,59,225,0.6);}
.name{margin-top:20px; font-size:32px; text-shadow:0 0 5px pink;}
.desc{margin-top:8px; font-size:28px; opacity:0.9; text-shadow:0 0 5px pink;}

.english{
  font-family:'Efont',sans-serif; 
  font-size:1.1em;
}

/* ---------------- ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ---------------- */
.music-box{
  position:absolute; bottom:30px; right:30px; width:450px; height:140px;
  background:rgba(0,0,0,0.2); border-radius:25px; backdrop-filter:blur(10px);
  padding:15px 20px; color:white; box-shadow:0 0 30px rgba(0,0,0,0.7);
  display:flex; flex-direction:column; justify-content:space-between; z-index:2;
  transition: width 0.3s ease, right 0.3s ease, transform 0.3s ease;
}

/* æ›²åã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ */
.music-title-container {
    max-width: calc(100% - 130px); 
    overflow: hidden; 
    white-space: nowrap; 
}
.music-info{
  font-size:20px;
  text-align:left;
  text-shadow:0 0 8px rgba(255,255,255,0.7);
  animation: none;
  display: inline-block;
  transform-origin: left center; 
  transform: scale(1); 
}

.controls{display:flex;justify-content:flex-end;gap:15px;margin-top:10px;}
.control-button{width:35px;height:35px;border-radius:50%;border:none;background:rgba(255,255,255,0.3);
  backdrop-filter:blur(5px);cursor:pointer;box-shadow:0 0 10px rgba(0,0,0,0.5);
  display:flex;align-items:center;justify-content:center;transition: transform 0.1s;}

/* âœ… ä¿®æ­£: ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã«æŠ¼ä¸‹æ„Ÿã‚’è¿½åŠ  */
.control-button:active {
    transform: scale(0.95); /* æŠ¼ã—ã¦ã„ã‚‹é–“ã€å°‘ã—å°ã•ã */
    filter: brightness(1.2); /* æŠ¼ã—ã¦ã„ã‚‹é–“ã€å°‘ã—æ˜ã‚‹ã */
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’å¼±ãã™ã‚‹ */
}
/* -------------------------------------------------------- */

.control-icon {
    width: 60%; 
    height: 60%; 
    object-fit: contain;
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.5));
}

.progress-container{width:100%;height:8px;background:rgba(255,255,255,0.2);border-radius:4px;overflow:hidden;margin-top:10px;cursor:pointer;position:relative;}
.progress-bar{width:0%;height:100%;background:rgba(255,255,255,0.7);border-radius:4px;}
.progress-knob{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.9);position:absolute;top:50%;transform:translate(-50%,-50%);cursor:pointer;}
.time-labels{display:flex;justify-content:space-between;font-size:16px;margin-top:3px;text-shadow:0 0 5px rgba(255,255,255,0.7);}
.time-labels span{animation: glow 1.5s infinite alternate;}
@keyframes glow{
  from{text-shadow:0 0 5px #fff;}
  to{text-shadow:0 0 15px #fff;}
}

/* ---------------- éŸ³é‡èª¿æ•´ãƒãƒ¼ ---------------- */
.volume-box{
    position:absolute; top:25px; right:30px; 
    width:200px; 
    height: 50px;
    background:rgba(0,0,0,0.2); border-radius:10px; backdrop-filter:blur(10px);
    padding:10px 15px; color:white; box-shadow:0 0 15px rgba(0,0,0,0.5);
    z-index:2;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: top 0.3s ease, right 0.3s ease, left 0.3s ease;
}

.volume-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    opacity: 0.8;
}

.volume-container{
    width:100%;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;
    margin-top:5px;cursor:pointer;position:relative;
}
.volume-bar{
    width:100%;height:100%;background:rgba(255,255,255,0.7);border-radius:3px;
}
.volume-knob{
    width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.9);
    position:absolute;top:50%;transform:translate(-50%,-50%);cursor:pointer;
    left: 100%; /* åˆæœŸä½ç½® */
}

/* ---------------- ä¸‹éƒ¨ãƒªãƒ³ã‚¯ / ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ---------------- */
.links{
    position:absolute;bottom:20px;width:100%;text-align:center; z-index:2; 
    transition: bottom 0.3s ease, left 0.3s ease, transform 0.3s ease; 
    display: flex;
    flex-wrap: wrap; 
    justify-content: center;
}
.links img{width:40px;margin:0 10px;cursor:pointer;border-radius:50%;filter:drop-shadow(0 0 var(--link-shadow,5px) black);}
#version{
  position:absolute;
  top: calc(100% - 20px - 1.5em); 
  left:20px;
  color:white;
  text-shadow:0 0 10px black, 0 0 5px black;
  font-size:18px; z-index:2;
  bottom: auto; 
}

/* ---------------- Enter Overlay ---------------- */
#enter-overlay{
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.9); 
  z-index:10;
  display:flex; justify-content:center; align-items:center;
  cursor:pointer; 
  opacity:0; 
  transition:opacity 0.5s ease, visibility 0.5s ease; 
  visibility:hidden; 
}
.enter-text{
  font-size:48px; font-weight:bold;
  color:white;
  text-shadow:0 0 20px white;
  animation: none; 
  transition: transform 0.5s ease;
  transform: scale(1); 
}

/* ---------------- Loading Overlay ---------------- */ 
#loading-overlay{
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,1); 
  z-index:20; 
  display:flex; justify-content:center; align-items:center;
  flex-direction: column;
  color:white;
  opacity:1; 
  transition:opacity 0.5s ease; 
  visibility:visible;
}
.loading-text{
  font-size:32px; font-weight:bold;
  margin-bottom: 20px;
  text-shadow:0 0 10px white;
}
.progress-bar-container{
  width: 80%;
  max-width: 300px;
  height: 8px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  overflow: hidden;
}
.loading-progress-bar{
  width: 0%;
  height: 100%;
  background: white; 
  border-radius: 4px;
  transition: width 0.3s ease;
}
/* ---------------- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª ---------------- */
@media (max-width: 900px), (max-aspect-ratio: 1/1) {
    .center-box {
        top: 25%; 
        transform: translate(-50%, -25%);
    }

    .music-box {
        right: 50%; 
        transform: translateX(50%);
    }
    
    .links {
        left: 50%;
        transform: translateX(-50%);
    }
    
    #version {
        top: 20px; 
        left: 20px;
        bottom: auto;
    }
}

@media (max-width: 500px) {
    .music-box {
        width: calc(100vw - 40px);
        max-width: 450px; 
    }
    
    .name { font-size: 28px; }
    .desc { font-size: 24px; }
    .music-info { font-size: 18px; }
}
</style>
</head>
<body>

<video id="background-video" autoplay loop muted playsinline>
  <source src="background.mp4" type="video/mp4">
</video>

<div id="loading-overlay">
  <div class="loading-text">LOADING...</div>
  <div id="loading-percent" style="font-size:24px; margin-bottom:10px; color:white; text-shadow:0 0 5px white;">0%</div>
  <div class="progress-bar-container">
    <div id="loading-progress-bar" class="loading-progress-bar"></div>
  </div>
</div>

<div id="enter-overlay">
  <div class="enter-text">Click to Enter!</div>
</div>

<div id="glow"></div>

<div class="volume-box" id="volume-box">
  <div class="volume-info">
    <span id="volume-label">VOLUME</span>
    <span id="volume-percent">100%</span>
  </div>
  <div class="volume-container" id="volume-container">
    <div class="volume-bar" id="volume-bar"></div>
    <div class="volume-knob" id="volume-knob"></div>
  </div>
</div>

<div class="center-box" id="center-box">
  <img src="icon.png" class="icon" id="icon-img">
  <div class="name" id="name-text">ã´ã‚ˆã ã‚ˆï½ï¼¾ï¼¾</div>
  <div class="desc" id="desc-text">èª¬æ˜æ–‡ãŒã“ã“ã«å…¥ã‚Šã¾ã™</div>
</div>

<div class="music-box">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div class="music-title-container">
        <div class="music-info" id="current-music">---</div>
    </div>
    <div class="controls">
      <button class="control-button" id="prev"><img src="prev.png" alt="Prev" class="control-icon"></button>
      <button class="control-button" id="play-pause"><img src="play.png" alt="Play" id="play-pause-icon" class="control-icon"></button>
      <button class="control-button" id="next"><img src="next.png" alt="Next" class="control-icon"></button>
    </div>
  </div>
  <div class="progress-container" id="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
    <div class="progress-knob" id="progress-knob"></div>
  </div>
  <div class="time-labels">
    <span id="current-time">0:00</span>
    <span id="total-time">0:00</span>
  </div>
  <audio id="audio"></audio>
</div>

<div class="links" id="links-box"></div>
<div id="version">v1.0</div>


<script>
// =========================================================
// é™çš„ã‚¢ã‚»ãƒƒãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–è¨­å®š
// =========================================================
document.getElementById('icon-img').src = getCacheBustedUrl('icon.png');
// NOTE: ãƒœã‚¿ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã®srcè¨­å®šã¯initializeAppå†…ã§DOMãŒæƒã£ãŸå¾Œã«å®Ÿè¡Œã—ã¾ã™ã€‚

const videoSource = document.querySelector('#background-video source');
if (videoSource) {
    videoSource.src = getCacheBustedUrl(videoSource.getAttribute('src'));
    document.getElementById('background-video').load(); 
}
// =========================================================


// ---------------- èƒŒæ™¯ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ ----------------
const bg = document.getElementById('background-video');
let mouseX=0, mouseY=0, currentX=0, currentY=0;
document.addEventListener('mousemove', e=>{
  mouseX=(e.clientX-window.innerWidth/2)*0.1;
  mouseY=(e.clientY-window.innerHeight/2)*0.1;
});
function animateBackground(){
  let dx=mouseX-currentX, dy=mouseY-currentY;
  let dist=Math.sqrt(dx*dx+dy*dy);
  let speed=dist>270?4:dist/270*4;
  if(dist>0){currentX+=dx/dist*speed; currentY+=dy/dist*speed;}
  bg.style.transform=`translate3d(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px),0) scale(1.1)`;
  requestAnimationFrame(animateBackground);
}
// animateBackgroundã¯ã€ã‚¢ãƒ—ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã€ã¾ãŸã¯DOMContentLoadedå¾Œã«é–‹å§‹ã—ã¾ã™ã€‚

// ---------------- Enterç”»é¢ã¨Loadingç”»é¢ã®åˆ¶å¾¡ ----------------

/**
 * Click to Enter! ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç† (éŸ³æ¥½å†ç”Ÿæ©Ÿèƒ½ã‚’è¿½åŠ )
 */
function enterOverlayClick() {
    const enterOverlay = document.getElementById('enter-overlay');
    const audio = document.getElementById('audio');
    const playPauseIcon = document.getElementById('play-pause-icon'); 
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å³åº§ã«è§£é™¤ã—ã€é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã‚’é˜²æ­¢
    enterOverlay.removeEventListener('click', enterOverlayClick);
    
    // 1. éŸ³æ¥½å†ç”Ÿã‚’è©¦ã¿ã‚‹ (ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã¨ã—ã¦å®Ÿè¡Œ)
    if (audio.paused) {
        audio.play().then(() => {
            // å†ç”Ÿã«æˆåŠŸã—ãŸå ´åˆã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’'pause'ã«æ›´æ–°
            playPauseIcon.src = getCacheBustedUrl('pause.png');
            playPauseIcon.alt = 'Pause';
        }).catch(e => {
            console.error("Audio play blocked on Click to Enter:", e);
            // å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯æ™‚: ã‚¢ã‚¤ã‚³ãƒ³ã¯ãã®ã¾ã¾'play' (åœæ­¢çŠ¶æ…‹)
        });
    }
    
    // 2. ç”»é¢ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    // Enterãƒ†ã‚­ã‚¹ãƒˆã‚’ç¸®å°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelector('.enter-text').style.transform = 'scale(0.5)';
    
    // Enterã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    enterOverlay.style.opacity = '0';
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«DOMã‹ã‚‰éš ã™
    setTimeout(() => {
        enterOverlay.style.visibility = 'hidden';
    }, 500); // CSSã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åˆã‚ã›ã‚‹
}

function showEnterScreen() {
    const loadingOverlay = document.getElementById('loading-overlay');
    const enterOverlay = document.getElementById('enter-overlay');
    
    // ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    loadingOverlay.style.opacity = '0';
    
    // Enterç”»é¢ã‚’è¡¨ç¤º
    enterOverlay.style.opacity = '1';
    enterOverlay.style.visibility = 'visible';

    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå®Œäº†å¾Œã«Loadingç”»é¢ã‚’DOMã‹ã‚‰éš ã™ (500ms)
    setTimeout(() => {
        loadingOverlay.style.visibility = 'hidden';
        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯å¾…ã¡çŠ¶æ…‹ã«æˆ»ã™
        enterOverlay.addEventListener('click', enterOverlayClick);
        
    }, 500); // Loadingãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚é–“ 500ms
}


/**
 * ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
 * @param {Object} cfg - config.jsonã®å†…å®¹
 * @param {Function} onReady - åˆæœŸã®æ›²ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
 */
function initializeApp(cfg, onReady) {
    animateBackground();
    
    const compactQuery = window.matchMedia('(max-width: 900px), (max-aspect-ratio: 1/1)');
    const glow = document.getElementById('glow');
    const bgVideo = document.getElementById('background-video');
    const enterOverlay = document.getElementById('enter-overlay');
    const audio=document.getElementById('audio');
    const currentMusicText=document.getElementById('current-music');
    const playPauseIcon = document.getElementById('play-pause-icon'); 
    const linkBox = document.getElementById('links-box');
    const musicBox = document.querySelector('.music-box'); 
    const progressBar=document.getElementById('progress-bar');
    const knob=document.getElementById('progress-knob');
    const playPauseBtn=document.getElementById('play-pause');
    const nextBtn=document.getElementById('next');
    const prevBtn=document.getElementById('prev');
    const currentTimeLabel=document.getElementById('current-time');
    const totalTimeLabel=document.getElementById('total-time');
    const centerBox = document.getElementById('center-box');
    
    // éŸ³é‡ãƒãƒ¼è¦ç´ ã®å–å¾—
    const volumeContainer = document.getElementById('volume-container');
    const volumeBar = document.getElementById('volume-bar');
    const volumeKnob = document.getElementById('volume-knob');
    const volumePercent = document.getElementById('volume-percent');


    let list = cfg.musics || [], current = 0;

    // é™çš„ã‚¢ã‚»ãƒƒãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–è¨­å®š (DOMãŒæƒã£ãŸå¾Œã«å®Ÿè¡Œ)
    document.getElementById('prev').querySelector('img').src = getCacheBustedUrl('prev.png');
    document.getElementById('play-pause-icon').src = getCacheBustedUrl('play.png');
    document.getElementById('next').querySelector('img').src = getCacheBustedUrl('next.png');


    // è¨­å®šã‹ã‚‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    glow.style.background=`rgb(${cfg.other.iconGlowColor})`;
    document.body.style.color=`rgb(${cfg.other.fontColor})`;
    document.getElementById('desc-text').innerText = cfg.other.description || 'description'; 
    document.getElementById('version').innerText = cfg.other.version || 'v1.0'; 

    const blurValue = cfg.other.backgroundBlur || 5; 
    const activeFilter = `blur(${blurValue}px)`;
    bgVideo.style.filter = activeFilter; 

    // ãƒªãƒ³ã‚¯ç”Ÿæˆ
    cfg.links.forEach(item=>{
      let url = item.url || item;
      let icon = item.icon || 'link.png';
      const a = document.createElement('a');
      a.href=url; a.target='_blank';
      
      a.innerHTML=`<img src="${getCacheBustedUrl(icon)}">`;
      
      if(item.shadow) {
          a.querySelector('img').style.setProperty('--link-shadow', `${item.shadow}px`);
      }
      linkBox.appendChild(a);
    });
    
    // =========================================================
    // ãƒªãƒ³ã‚¯ã¨ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é‡ãªã‚Šé˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯
    // =========================================================
    
    function calculateLinkHalfWidth() {
        const linksCount = cfg.links ? cfg.links.length : 0;
        const totalWidth = linksCount * 60; // ãƒªãƒ³ã‚¯1å€‹ã‚ãŸã‚Š 60px (40px + 20px)
        return totalWidth / 2;
    }
    
    function adjustPlayerPosition(linkHalfWidth) {
        const PLAYER_MIN_WIDTH = 450;
        const DEFAULT_RIGHT_MARGIN = 30;
        const SAFE_MARGIN_HORIZONTAL = 50; 

        const halfScreenWidth = window.innerWidth / 2;
        const linkWidthFromCenter = linkHalfWidth;

        const linkRightEdgeFromCenter = linkWidthFromCenter;
        const playerLeftEdgeFromCenterDefault = halfScreenWidth - (PLAYER_MIN_WIDTH + DEFAULT_RIGHT_MARGIN);
        
        
        if (linkRightEdgeFromCenter + SAFE_MARGIN_HORIZONTAL > playerLeftEdgeFromCenterDefault) {
            musicBox.style.right = '50%';
            musicBox.style.transform = 'translateX(50%)';
            
            return true; 
        } else {
            musicBox.style.right = `${DEFAULT_RIGHT_MARGIN}px`;
            musicBox.style.transform = 'none';
            
            return false;
        }
    }


    const SAFE_MARGIN_VERTICAL = 50; 

    function adjustLinkPosition() {
        
        if (!compactQuery.matches) {
            
            const isOverlapping = adjustPlayerPosition(calculateLinkHalfWidth());
            
            if (isOverlapping) {
                
                // Wide screen, overlap: Move center box up via inline style
                centerBox.style.top = '25%'; 
                centerBox.style.transform = 'translate(-50%, -25%)';

                if (!musicBox || !linkBox || !linkBox.hasChildNodes()) return;

                const musicBoxRect = musicBox.getBoundingClientRect();
                const musicBoxTop = musicBoxRect.top;
                
                const musicBoxTopFromBottom = window.innerHeight - musicBoxTop;
                
                const newBottom = musicBoxTopFromBottom + SAFE_MARGIN_VERTICAL;

                linkBox.style.bottom = `${newBottom}px`;
            } else {
                
                // Wide screen, no overlap: Center center box via inline style
                centerBox.style.top = '50%';
                centerBox.style.transform = 'translate(-50%, -50%)';
                
                linkBox.style.bottom = '20px'; 
            }
            
        } else {
            // Compact layout: Clear inline styles so CSS @media takes over
            centerBox.style.top = ''; 
            centerBox.style.transform = ''; 
            
            if (!musicBox || !linkBox || !linkBox.hasChildNodes()) return;

            const musicBoxRect = musicBox.getBoundingClientRect();
            const musicBoxTop = musicBoxRect.top;
            
            const musicBoxTopFromBottom = window.innerHeight - musicBoxTop;
            
            const newBottom = musicBoxTopFromBottom + SAFE_MARGIN_VERTICAL;

            linkBox.style.bottom = `${newBottom}px`;
        }
    }

    compactQuery.addListener(adjustLinkPosition); 
    window.addEventListener('resize', adjustLinkPosition); 
    
    setTimeout(adjustLinkPosition, 200); 
    // =========================================================

    // ---------------- éŸ³é‡åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ ----------------
    
    audio.volume = 1.0; 
    
    function updateVolumeDisplay() {
        const percent = audio.volume * 100;
        volumeBar.style.width = percent + '%';
        volumeKnob.style.left = percent + '%';
        volumePercent.innerText = Math.round(percent) + '%';
    }

    let volumeDragging = false;
    volumeKnob.addEventListener('mousedown', (e) => {
        e.preventDefault(); 
        volumeDragging = true;
    });
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¯ãƒªãƒƒã‚¯æ“ä½œ
    volumeContainer.addEventListener('click', e => {
      if (volumeDragging) return; 
      
      const rect = volumeContainer.getBoundingClientRect();
      let volume = (e.clientX - rect.left) / rect.width;
      volume = Math.max(0, Math.min(1, volume)); 
      audio.volume = volume;
      updateVolumeDisplay();
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('mouseup', () => volumeDragging = false);
    document.addEventListener('mousemove', e => {
      if (volumeDragging) {
        const rect = volumeContainer.getBoundingClientRect();
        let volume = (e.clientX - rect.left) / rect.width;
        volume = Math.max(0, Math.min(1, volume)); 
        audio.volume = volume;
        updateVolumeDisplay();
      }
    });

    updateVolumeDisplay(); // åˆæœŸè¡¨ç¤ºã‚’è¨­å®š
    // --------------------------------------------------------


    function getSongName(f){ return f.replace(/\.mp3$/i,''); }
    
    function updatePlayPause(){ 
      if (!playPauseIcon) return;
      
      // NOTE: ã“ã®é–¢æ•°ã¯å†ç”Ÿãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã«å‘¼ã³å‡ºã•ã‚Œã€audio.pausedã®çŠ¶æ…‹ãŒé€†ã«ãªã‚‹ã“ã¨ãŒå‰æã€‚
      // enterOverlayClickã§ç›´æ¥ã‚¢ã‚¤ã‚³ãƒ³ã‚’pauseã«æ›´æ–°ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãã®ã¾ã¾ã€‚
    }

    function playMusic(index){
      current=index;
      
      if (!list[current]) {
          currentMusicText.innerHTML = '---';
          currentMusicText.style.animation = 'none';
          currentMusicText.style.transform = 'none';
          return;
      }
      
      audio.src = getCacheBustedUrl(list[current]);
      audio.load(); 
      
      const songName = getSongName(list[current]);
      currentMusicText.innerHTML = songName.replace(/[A-Za-z0-9]/g, m=>`<span class="english">${m}</span>`);
      
      // éŸ³æ¥½ã¯åœæ­¢çŠ¶æ…‹ã‹ã‚‰å§‹ã‚ã‚‹
      playPauseIcon.src = getCacheBustedUrl('play.png');
      playPauseIcon.alt = 'Play';

      // æ›²åãŒé•·ã„å ´åˆã®ãƒãƒ¼ã‚­ãƒ¼å‡¦ç†
      setTimeout(() => {
          const container = document.querySelector('.music-title-container');
          const containerWidth = container ? container.offsetWidth : 0;
          const textWidth = currentMusicText.offsetWidth;

          if (textWidth > containerWidth && containerWidth > 0) {
              const scrollDistance = containerWidth - textWidth - 5; 
              
              currentMusicText.style.setProperty('--scroll-offset', `${scrollDistance}px`);
              currentMusicText.style.animation = 'marquee 8s linear infinite alternate'; 
          } else {
              currentMusicText.style.animation = 'none';
              currentMusicText.style.transform = 'none';
          }
      }, 0); 
    }
    
    
    function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60); return `${m}:${s<10?'0'+s:s}`; }
    
    // æ°¸ç¶šçš„ãªãƒªã‚¹ãƒŠãƒ¼: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãŸã³ã«åˆè¨ˆæ™‚é–“ã‚’æ›´æ–°
    audio.addEventListener('loadedmetadata', ()=>{ totalTimeLabel.innerText=formatTime(audio.duration); });

    audio.addEventListener('timeupdate', ()=>{
      const percent=(audio.currentTime/audio.duration)*100;
      progressBar.style.width=percent+'%';
      knob.style.left=percent+'%';
      currentTimeLabel.innerText=formatTime(audio.currentTime);
    });

    audio.addEventListener('ended', ()=>{ playMusic((current+1)%list.length); });

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ“ä½œ
    let dragging=false;
    knob.addEventListener('mousedown',(e)=>{ 
        e.preventDefault(); 
        dragging=true;
    });
    document.addEventListener('mouseup',()=>dragging=false);
    document.addEventListener('mousemove', e=>{
      if(dragging){
        const rect=document.getElementById('progress-container').getBoundingClientRect();
        let percent=(e.clientX-rect.left)/rect.width;
        percent=Math.max(0,Math.min(1,percent));
        audio.currentTime=percent*audio.duration;
      }
    });

    // å†ç”Ÿãƒ»åœæ­¢ãƒœã‚¿ãƒ³
    playPauseBtn.addEventListener('click', ()=>{
      
      if(audio.paused) {
          audio.play().then(() => {
            // å†ç”ŸæˆåŠŸæ™‚
            playPauseIcon.src = getCacheBustedUrl('pause.png'); 
            playPauseIcon.alt = 'Pause';
          }).catch(e => {
            // å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯æ™‚
            console.error("Audio play blocked:", e);
            playPauseIcon.src = getCacheBustedUrl('play.png'); 
            playPauseIcon.alt = 'Play';
          });
      } else {
          audio.pause();
          playPauseIcon.src = getCacheBustedUrl('play.png'); 
          playPauseIcon.alt = 'Play';
      }
    });
    
    nextBtn.addEventListener('click', ()=>{ playMusic((current+1)%list.length); });
    prevBtn.addEventListener('click', ()=>{ playMusic((current-1+list.length)%list.length); });

    // åˆæœŸæ›²ã®ãƒ­ãƒ¼ãƒ‰ (å†ç”Ÿã¯ã—ãªã„)
    if (list.length > 0) {
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰onReadyã‚’å®Ÿè¡Œã™ã‚‹ä¸€æ™‚çš„ãªãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
        audio.addEventListener('loadedmetadata', onReady, { once: true });
        
        playMusic(0); 
    } else {
        onReady(); // éŸ³æ¥½ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã¯ã™ãã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
    }
}


// ---------------- ã‚¢ã‚»ãƒƒãƒˆã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã¨åˆæœŸåŒ–ã®åˆ¶å¾¡ ----------------

document.addEventListener('DOMContentLoaded', () => {
    const loadingProgressBar = document.getElementById('loading-progress-bar');
    const loadingPercentDisplay = document.getElementById('loading-percent'); // ğŸ’¡ NEW: ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤ºè¦ç´ ã‚’å–å¾—
    
    // 1. config.json ã®ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰é–‹å§‹
    fetch(getCacheBustedUrl('config.json')) 
      .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
      })
      .then(cfg => {
        
        // 2. ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¢ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã®å®šç¾©
        const assetsToLoad = [
            'icon.png', 'prev.png', 'play.png', 'next.png',
        ];

        // ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
        if (cfg.links) {
            cfg.links.forEach(item => {
                if (item.icon) assetsToLoad.push(item.icon);
            });
        }
        // æœ€åˆã®éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ  (å…¨æ›²ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã‚‹ãŸã‚)
        if (cfg.musics && cfg.musics.length > 0) {
            assetsToLoad.push(cfg.musics[0]); 
        }
        
        const totalAssets = assetsToLoad.length;
        let loadedCount = 0;
        
        // ã‚¢ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰é–¢æ•°
        const loadAsset = (assetPath) => {
            return new Promise((resolve, reject) => {
                const cacheBustedUrl = getCacheBustedUrl(assetPath);
                
                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
                if (assetPath.match(/\.(png|jpg|jpeg|gif)$/i)) {
                    const img = new Image();
                    img.onload = resolve;
                    img.onerror = resolve; // ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã—ã¦ã‚‚é€²è¡Œã‚’æ­¢ã‚ãªã„
                    img.src = cacheBustedUrl;
                } 
                // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
                else if (assetPath.match(/\.(mp3|wav|ogg)$/i)) {
                    const audioPreload = new Audio();
                    audioPreload.addEventListener('canplaythrough', resolve, {once: true});
                    audioPreload.addEventListener('error', resolve, {once: true});
                    audioPreload.src = cacheBustedUrl;
                    audioPreload.load();
                } 
                // ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¸»ã«ãƒªãƒ³ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ä»¥å¤–ã®ã€å¿µã®ãŸã‚ã®ã‚‚ã®ï¼‰
                else {
                    fetch(cacheBustedUrl).then(resolve).catch(resolve);
                }
            }).finally(() => {
                loadedCount++;
                const progress = (loadedCount / totalAssets) * 100;
                loadingProgressBar.style.width = `${progress}%`;
                
                // ğŸ’¡ NEW: ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤ºã‚’æ›´æ–°
                if (loadingPercentDisplay) {
                    loadingPercentDisplay.innerText = `${Math.round(progress)}%`;
                }
            });
        };
        
        // 3. ãƒ­ãƒ¼ãƒ‰ã®é–‹å§‹
        const assetPromises = assetsToLoad.map(loadAsset);

        // 4. å…¨ã¦ã®ã‚¢ã‚»ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã¤
        Promise.all(assetPromises).then(() => {
            // ã‚²ãƒ¼ã‚¸ã‚’100%ã«
            loadingProgressBar.style.width = '100%';
            if (loadingPercentDisplay) { 
                loadingPercentDisplay.innerText = '100%'; // ç¢ºå®Ÿã«100%ã‚’è¡¨ç¤º
            }
            
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã¨Enterç”»é¢ã¸ã®é·ç§»ï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ã‚Šï¼‰
            setTimeout(() => { 
                // initializeAppã‚’å‘¼ã³å‡ºã—ã€åˆæœŸæ›²ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¦ã‹ã‚‰showEnterScreenã‚’å‘¼ã³å‡ºã™
                initializeApp(cfg, showEnterScreen); 
            }, 100); 
        });

      })
      .catch(error => {
        // config.jsonã®ãƒ­ãƒ¼ãƒ‰å¤±æ•—æ™‚ï¼ˆè‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼‰
        console.error("Failed to load config.json. Initializing with empty settings.", error);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚Enterç”»é¢ã¸é·ç§»
        const dummyConfig = { musics: [], links: [], other: { iconGlowColor: '255,255,255', fontColor: '255,255,255', description: 'ã‚¨ãƒ©ãƒ¼: è¨­å®šã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ', version: 'v1.0' } };
        loadingProgressBar.style.width = '100%';
        if (loadingPercentDisplay) { 
            loadingPercentDisplay.innerText = '100%';
        }
        setTimeout(() => {
             initializeApp(dummyConfig, showEnterScreen); // éŸ³æ¥½ãŒãªã„ã®ã§ã™ãã«showEnterScreenãŒå‘¼ã°ã‚Œã‚‹
        }, 100);
      });
});
</script>

</body>
</html>
