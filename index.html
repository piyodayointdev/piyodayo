<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Piyo Profile</title>

<script>
// 毎回開くたびに新しいフォントが使用されるように、キャッシュを無効化する処理
(function() {
    // 現在時刻をミリ秒で取得し、ユニークなクエリパラメータとして使用
    const timestamp = new Date().getTime(); 
    
    // @font-faceルールにキャッシュ無効化のためのクエリパラメータを追加
    const fontRules = `
        @font-face {
            font-family: 'Jfont';
            src: url('Jfont.woff?v=${timestamp}') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap; /* フォントの読み込み中に代替フォントを表示 */
        }
        @font-face {
            font-family: 'Efont';
            src: url('Efont.woff?v=${timestamp}') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
    `;
    
    // スタイルタグを作成し、定義したルールを<head>に挿入
    const style = document.createElement('style');
    style.textContent = fontRules;
    document.head.appendChild(style);
})();
</script>

<style>
/* ---------------- 基本スタイル ---------------- */
*{margin:0;padding:0;box-sizing:border-box;}
body,html{
  width:100%;height:100%;overflow-x:hidden; /* 横スクロールを防ぐ */
  /* カスタムフォントを適用 */
  font-family:'Jfont','Efont',sans-serif;
  font-size:16px;color:white;background:#000;
  /* フォントを滑らかにする設定 */
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ---------------- 背景動画 ---------------- */
#background-video{
  position:fixed; top:50%; left:50%;
  width:110%; height:110%;
  transform:translate3d(-50%,-50%,0) scale(1.1);
  object-fit:cover; z-index:0; will-change: transform;
  /* 背景を暗くする設定を削除し、ブラーのみ残す */
  filter: blur(5px); 
}

/* ---------------- 主要コンテンツ ---------------- */
.center-box{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  text-align:center; z-index:2;
  /* レスポンシブ対応のため transition を追加 */
  transition: top 0.3s ease, transform 0.3s ease;
}
.icon{width:150px; height:150px; border-radius:50%; overflow:hidden; box-shadow:0 0 40px rgba(246,59,225,0.6);}
.name{margin-top:20px; font-size:32px; text-shadow:0 0 5px pink;}
.desc{margin-top:8px; font-size:28px; opacity:0.9; text-shadow:0 0 5px pink;}

/* 英文字だけ大きくする */
.english{
  /* カスタムフォントを適用 */
  font-family:'Efont',sans-serif; 
  font-size:1.1em;
}

/* ---------------- ミュージックプレイヤー ---------------- */
.music-box{
  position:absolute; bottom:30px; right:30px; width:450px; height:140px;
  background:rgba(0,0,0,0.2); border-radius:25px; backdrop-filter:blur(10px);
  padding:15px 20px; color:white; box-shadow:0 0 30px rgba(0,0,0,0.7);
  display:flex; flex-direction:column; justify-content:space-between; z-index:2;
  /* レスポンシブ対応のため transition を追加 */
  transition: width 0.3s ease, right 0.3s ease, transform 0.3s ease;
}

/* 曲名スクロールのためのコンテナ */
.music-title-container {
    /* プレイヤーの幅からコントロールボタンの幅を引いた、表示エリアの最大幅 */
    max-width: calc(100% - 130px); 
    overflow: hidden; /* はみ出た部分を隠す */
    white-space: nowrap; /* テキストの折り返しを禁止 */
}
.music-info{
  font-size:20px;
  text-align:left;
  text-shadow:0 0 8px rgba(255,255,255,0.7);
  animation: none;
  display: inline-block; /* インラインブロックにすることで幅を正確に取得 */
}
/* 曲名スクロールのアニメーション定義 */
@keyframes marquee {
    0% { transform: translateX(0); }
    50% { transform: translateX(var(--scroll-offset)); }
    100% { transform: translateX(0); }
}

.controls{display:flex;justify-content:flex-end;gap:15px;margin-top:10px;}
.control-button{width:35px;height:35px;border-radius:50%;border:none;background:rgba(255,255,255,0.3);
  backdrop-filter:blur(5px);cursor:pointer;box-shadow:0 0 10px rgba(0,0,0,0.5);
  display:flex;align-items:center;justify-content:center;transition: transform 0.1s;}

/* ボタン内の画像スタイル */
.control-icon {
    width: 60%; 
    height: 60%; 
    object-fit: contain;
    filter: drop-shadow(0 0 1px rgba(0,0,0,0.5));
}

.progress-container{width:100%;height:8px;background:rgba(255,255,255,0.2);border-radius:4px;overflow:hidden;margin-top:10px;cursor:pointer;position:relative;}
.progress-bar{width:0%;height:100%;background:rgba(255,255,255,0.7);border-radius:4px;}
.progress-knob{width:14px;height:14px;border-radius:50%;background:rgba(255,255,255,0.9);position:absolute;top:50%;transform:translate(-50%,-50%);cursor:pointer;}
.time-labels{display:flex;justify-content:space-between;font-size:16px;margin-top:3px;text-shadow:0 0 5px rgba(255,255,255,0.7);}
.time-labels span{animation: glow 1.5s infinite alternate;}
@keyframes glow{
  from{text-shadow:0 0 5px #fff;}
  to{text-shadow:0 0 15px #fff;}
}

/* ---------------- 下部リンク / バージョン ---------------- */
.links{position:absolute;bottom:20px;width:100%;text-align:center; z-index:2;}
.links img{width:40px;margin:0 10px;cursor:pointer;border-radius:50%;filter:drop-shadow(0 0 var(--link-shadow,5px) black);}
#version{
  position:absolute;bottom:20px;left:20px;color:white;
  text-shadow:0 0 10px black, 0 0 5px black;
  font-size:18px; z-index:2;
}

/* ---------------- Enter Overlay ---------------- */
#enter-overlay{
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.9); 
  z-index:10;
  display:flex; justify-content:center; align-items:center;
  cursor:pointer;
  opacity:1; 
  transition:opacity 0.5s ease, visibility 0.5s ease;
  visibility:visible;
}
.enter-text{
  font-size:48px; font-weight:bold;
  color:white;
  text-shadow:0 0 20px white;
  animation: none; 
  transition: transform 0.5s ease;
  transform: scale(1); 
}

/* ---------------- レスポンシブ メディアクエリ ---------------- */
@media (max-width: 900px) {
    /* 画面幅が900px以下になったらロゴを上に移動 */
    .center-box {
        top: 25%; 
        transform: translate(-50%, -25%);
    }

    /* ミュージックプレイヤーの位置を中央に寄せる */
    .music-box {
        right: 50%; 
        transform: translateX(50%);
    }
    
    /* リンクをミュージックプレイヤーの上に移動 */
    .links {
        position: absolute;
        bottom: 190px; /* プレイヤーの高さ(140px) + 余白(50px) */
        width: 100%;
        text-align: center;
        z-index: 2;
        /* 右端固定から中央に移動 */
        left: 50%;
        transform: translateX(-50%);
    }
    
    /* バージョンを左上に移動 */
    #version {
        bottom: auto; /* 左下の指定を解除 */
        top: 20px; /* 上から20pxに設定 */
        left: 20px;
        font-size: 18px;
        z-index: 2;
    }
}

@media (max-width: 500px) {
    /* 画面幅が500px以下になったらミュージックプレイヤーの幅を縮小 */
    .music-box {
        /* 画面左右に20pxずつマージンを確保 */
        width: calc(100vw - 40px);
        /* 最大幅は450pxを維持 */
        max-width: 450px; 
    }
    
    /* フォントサイズの調整（任意） */
    .name { font-size: 28px; }
    .desc { font-size: 24px; }
    .music-info { font-size: 18px; }
}
</style>
</head>
<body>

<video id="background-video" autoplay loop muted playsinline>
  <source src="background.mp4" type="video/mp4">
</video>

<div id="enter-overlay">
  <div class="enter-text">Click to Enter!</div>
</div>

<div id="glow"></div>

<div class="center-box">
  <img src="icon.png" class="icon">
  <div class="name" id="name-text">ぴよだよ～＾＾</div>
  <div class="desc" id="desc-text">description</div>
</div>

<div class="music-box">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div class="music-title-container">
        <div class="music-info" id="current-music">---</div>
    </div>
    <div class="controls">
      <button class="control-button" id="prev"><img src="prev.png" alt="Prev" class="control-icon"></button>
      <button class="control-button" id="play-pause"><img src="play.png" alt="Play" id="play-pause-icon" class="control-icon"></button>
      <button class="control-button" id="next"><img src="next.png" alt="Next" class="control-icon"></button>
    </div>
  </div>
  <div class="progress-container" id="progress-container">
    <div class="progress-bar" id="progress-bar"></div>
    <div class="progress-knob" id="progress-knob"></div>
  </div>
  <div class="time-labels">
    <span id="current-time">0:00</span>
    <span id="total-time">0:00</span>
  </div>
  <audio id="audio"></audio>
</div>

<div class="links" id="links-box"></div>
<div id="version">Error Version</div>

<script>
// ---------------- 背景パララックス ----------------
const bg = document.getElementById('background-video');
let mouseX=0, mouseY=0, currentX=0, currentY=0;
document.addEventListener('mousemove', e=>{
  mouseX=(e.clientX-window.innerWidth/2)*0.1;
  mouseY=(e.clientY-window.innerHeight/2)*0.1;
});
function animateBackground(){
  let dx=mouseX-currentX, dy=mouseY-currentY;
  let dist=Math.sqrt(dx*dx+dy*dy);
  let speed=dist>270?4:dist/270*4;
  if(dist>0){currentX+=dx/dist*speed; currentY+=dy/dist*speed;}
  bg.style.transform=`translate3d(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px),0) scale(1.1)`;
  requestAnimationFrame(animateBackground);
}
animateBackground();

// ---------------- ミュージックプレイヤーなど ----------------
const enterOverlay = document.getElementById('enter-overlay');
const bgVideo = document.getElementById('background-video');

// Enter画面クリック時の処理
function enterOverlayClick() {
    // 画面遷移の処理をまず実行し、必ずページに入れるようにする
    document.querySelector('.enter-text').style.transform = 'scale(0.5)';
    enterOverlay.style.opacity = '0';
    enterOverlay.style.visibility = 'hidden';
    enterOverlay.removeEventListener('click', enterOverlayClick);
    
    // 背景フィルタを適用
    const blurValue = 5; 
    bgVideo.style.filter = `blur(${blurValue}px)`;

    // config.jsonの読み込みと音楽再生の開始を試行
    fetchAndStartMusic();
}

// Enter画面にクリックイベントを登録
enterOverlay.addEventListener('click', enterOverlayClick);


// fetchの処理を関数化し、クリック後に呼び出す
function fetchAndStartMusic() {
  fetch('config.json')
    .then(r => {
        // HTTPエラーコード(404など)の場合もここでエラーを投げる
        if (!r.ok) {
            throw new Error(`HTTP error! status: ${r.status}`);
        }
        return r.json();
    })
    .then(cfg => {
      // config.jsonが読み込めた場合の処理

      const glow = document.getElementById('glow');
      const audio=document.getElementById('audio');
      const currentMusicText=document.getElementById('current-music');
      const progressBar=document.getElementById('progress-bar');
      const knob=document.getElementById('progress-knob');
      const playPauseBtn=document.getElementById('play-pause');
      const nextBtn=document.getElementById('next');
      const prevBtn=document.getElementById('prev');
      const currentTimeLabel=document.getElementById('current-time');
      const totalTimeLabel=document.getElementById('total-time');
      const playPauseIcon = document.getElementById('play-pause-icon'); 
      const linkBox = document.getElementById('links-box');
      
      let list = cfg.musics || [], current = 0;
      let hasPlayedOnce = true; 

      // 設定からスタイルを適用
      glow.style.background=`rgb(${cfg.other.iconGlowColor})`;
      document.body.style.color=`rgb(${cfg.other.fontColor})`;
      // descriptionとversionをconfigの値で更新
      document.getElementById('desc-text').innerText = cfg.other.description || 'description'; 
      document.getElementById('version').innerText = cfg.other.version || 'Error Version'; 

      // 背景ブラーをconfigの値に更新
      const blurValue = cfg.other.backgroundBlur || 5; 
      bgVideo.style.filter = `blur(${blurValue}px)`;

      // リンク生成
      cfg.links.forEach(item=>{
        let url = item.url || item;
        let icon = item.icon || 'link.png';
        const a = document.createElement('a');
        a.href=url; a.target='_blank';
        a.innerHTML=`<img src="${icon}">`;
        if(item.shadow) {
            a.querySelector('img').style.setProperty('--link-shadow', `${item.shadow}px`);
        }
        linkBox.appendChild(a);
      });

      function getSongName(f){ return f.replace(/\.mp3$/i,''); }
      
      function updatePlayPause(){ 
        if (!playPauseIcon) return;
        playPauseIcon.src = audio.paused ? 'play.png' : 'pause.png'; 
        playPauseIcon.alt = audio.paused ? 'Play' : 'Pause'; 
      }

      function playMusic(index){
        current=index;
        
        // 音楽ファイルのパスが有効か確認
        if (!list[current]) {
            currentMusicText.innerHTML = '---';
            currentMusicText.style.animation = 'none';
            currentMusicText.style.transform = 'none';
            return;
        }

        audio.src=list[current];
        audio.load(); 
        
        // 曲名設定
        const songName = getSongName(list[current]);
        currentMusicText.innerHTML = songName.replace(/[A-Za-z0-9]/g, m=>`<span class="english">${m}</span>`);
        updatePlayPause();

        if(hasPlayedOnce) {
            // メタデータロード完了後に再生を試みる
            audio.addEventListener('loadedmetadata', function startPlayOnce() {
                audio.removeEventListener('loadedmetadata', startPlayOnce); 
                
                audio.play().catch(e => {
                    console.error("Audio play blocked/failed:", e);
                });
            });
        }
        
        // 曲名が長い場合のマーキー処理
        setTimeout(() => {
            const container = document.querySelector('.music-title-container');
            const containerWidth = container ? container.offsetWidth : 0;
            const textWidth = currentMusicText.offsetWidth;

            if (textWidth > containerWidth && containerWidth > 0) {
                const scrollDistance = containerWidth - textWidth - 5; 
                
                currentMusicText.style.setProperty('--scroll-offset', `${scrollDistance}px`);
                currentMusicText.style.animation = 'marquee 8s linear infinite alternate'; 
            } else {
                currentMusicText.style.animation = 'none';
                currentMusicText.style.transform = 'none';
            }
        }, 0); 
      }
      
      // 音楽再生を開始
      if (list.length > 0) {
        playMusic(0);
      }

      function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60); return `${m}:${s<10?'0'+s:s}`; }
      audio.addEventListener('loadedmetadata', ()=>{ totalTimeLabel.innerText=formatTime(audio.duration); });
      audio.addEventListener('timeupdate', ()=>{
        const percent=(audio.currentTime/audio.duration)*100;
        progressBar.style.width=percent+'%';
        knob.style.left=percent+'%';
        currentTimeLabel.innerText=formatTime(audio.currentTime);
      });

      // 曲終了時に次の曲
      audio.addEventListener('ended', ()=>{ playMusic((current+1)%list.length); });

      // プログレスバー操作
      let dragging=false;
      knob.addEventListener('mousedown',()=>dragging=true);
      document.addEventListener('mouseup',()=>dragging=false);
      document.addEventListener('mousemove', e=>{
        if(dragging){
          const rect=document.getElementById('progress-container').getBoundingClientRect();
          let percent=(e.clientX-rect.left)/rect.width;
          percent=Math.max(0,Math.min(1,percent));
          audio.currentTime=percent*audio.duration;
        }
      });

      // 再生・停止ボタン
      playPauseBtn.addEventListener('click', ()=>{
        if(audio.paused) audio.play(); else audio.pause();
        updatePlayPause();
      });
      nextBtn.addEventListener('click', ()=>{ playMusic((current+1)%list.length); });
      prevBtn.addEventListener('click', ()=>{ playMusic((current-1+list.length)%list.length); });
    })
    .catch(error => {
      // config.jsonの読み込みに失敗した場合
      console.error("Failed to load config.json. Music player and settings will not function.", error);
      // エラー時もHTMLの初期表示が維持されます。
    });
}
</script>

</body>
</html>
